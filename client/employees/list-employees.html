<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Danh sách nhân viên</title>

    <!-- Icon -->
    <link
      rel="icon"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.18.1/icons/house-fill.svg"
    />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <style>
      .card-body {
        overflow-x: auto;
      }
    </style>
  </head>

  <body>
    <section>
      <div class="container mt-5">
        <div class="d-flex" style="gap: 10px">
          <button
            class="btn btn-primary my-2"
            data-bs-toggle="modal"
            data-bs-target="#addEmployeeModal"
          >
            Thêm nhân viên
          </button>
          <a href="../index.html" class="btn btn-secondary my-2">Trang chủ</a>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Danh sách nhân viên</h3>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">#STT</th>
                  <th scope="col">Họ và tên</th>
                  <th scope="col">Chức vụ</th>
                  <th scope="col">Mã số thuế</th>
                  <th scope="col">Địa chỉ</th>
                  <th scope="col">Số điện thoại</th>
                  <th scope="col">TKNH</th>
                  <th scope="col">Email</th>
                  <th scope="col">Ngày sinh</th>
                  <th scope="col">Ngày bắt đầu</th>
                  <th scope="col">Lương</th>
                  <th scope="col">Trạng thái</th>
                  <th scope="col">Hành động</th>
                </tr>
              </thead>
              <tbody id="list-employees"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Modal for Adding/Editing Employee -->
    <div
      class="modal fade"
      id="addEmployeeModal"
      tabindex="-1"
      aria-labelledby="addEmployeeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addEmployeeModalLabel">
              Thêm nhân viên mới
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addEmployeeForm">
              <input type="hidden" id="employeeId" name="employeeId" />
              <div class="mb-3">
                <label for="fullName" class="form-label">Họ và tên</label>
                <input
                  type="text"
                  class="form-control"
                  id="fullName"
                  name="fullName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="position" class="form-label">Chức vụ</label>
                <select
                  class="form-control"
                  id="position"
                  name="position"
                  required
                >
                  <option value="manager">Quản lý</option>
                  <option value="employee">Nhân viên</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="taxCode" class="form-label">Mã số thuế</label>
                <input
                  type="text"
                  class="form-control"
                  id="taxCode"
                  name="taxCode"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="address" class="form-label">Địa chỉ</label>
                <input
                  type="text"
                  class="form-control"
                  id="address"
                  name="address"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="phone" class="form-label">Số điện thoại</label>
                <input
                  type="text"
                  class="form-control"
                  id="phone"
                  name="phone"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="bankAccount" class="form-label"
                  >Tài khoản ngân hàng</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="bankAccount"
                  name="bankAccount"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  required
                />
              </div>
              <div id="addPassword"></div>
              <div class="mb-3">
                <label for="birthday" class="form-label">Ngày sinh</label>
                <input
                  type="date"
                  class="form-control"
                  id="birthday"
                  name="birthday"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="startDate" class="form-label">Ngày bắt đầu</label>
                <input
                  type="date"
                  class="form-control"
                  id="startDate"
                  name="startDate"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="salary" class="form-label">Lương</label>
                <input
                  type="number"
                  class="form-control"
                  id="salary"
                  name="salary"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="status" class="form-label">Trạng thái</label>
                <select class="form-control" id="status" name="status" required>
                  <option value="active">Hoạt động</option>
                  <option value="inactive">Không hoạt động</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">
                Lưu thay đổi
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Jquery từ CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap -->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>

    <!-- Custom JavaScript -->
    <script>
      $(document).ready(function () {
        const listEmployees = $("#list-employees");

        // Load danh sách nhân viên
        function loadEmployees() {
          $.ajax({
            url: "http://localhost:8081/api/employees/all",
            type: "GET",
            success: function (data) {
              listEmployees.empty();
              data.forEach((item, index) => {
                listEmployees.append(`
                            <tr>
                                <th scope="row">${index + 1}</th>
                                <td>${item.fullName || ""}</td>
                                <td>${
                                  item.position == "manager"
                                    ? "quản lý"
                                    : "nhân viên" || ""
                                }</td>
                                <td>${item.taxCode || ""}</td>
                                <td>${item.address || ""}</td>
                                <td>${item.phone || ""}</td>
                                <td>${item.bankAccount || ""}</td>
                                <td>${item.email || ""}</td>
                                <td>${item.dateOfBirth || ""}</td>
                                <td>${item.startDate || ""}</td>
                                <td>${item.salary || ""}</td>
                                <td>${item.status || ""}</td>
                                <td>
                                    <button class="btn btn-warning btn-edit" data-id="${
                                      item.employeeId
                                    }">Sửa</button>
                                    <button class="btn btn-danger btn-delete" data-id="${
                                      item.employeeId
                                    }">Xóa</button>
                                </td>
                            </tr>
                            `);
              });

              // Gắn sự kiện cho các nút "Sửa" và "Xóa"
              $(".btn-edit").click(handleEdit);
              $(".btn-delete").click(handleDelete);
            },
            error: function (error) {
              console.log(error);
              alert("Đã xảy ra lỗi khi tải dữ liệu nhân viên.");
            },
          });
        }

        function handleEdit() {
          const id = $(this).data("id");
          console.log("Edit ID:", id); // Kiểm tra giá trị của ID

          if (!id) {
            alert("ID của nhân viên không hợp lệ. Vui lòng thử lại.");
            return;
          }

          $.ajax({
            url: `http://localhost:8081/api/employees/${id}`,
            type: "GET",
            success: function (data) {
              // Điền dữ liệu vào form modal
              $("#employeeId").val(data.employeeId);
              $("#fullName").val(data.fullName);
              $("#position").val(data.position);
              $("#taxCode").val(data.taxCode);
              $("#address").val(data.address);
              $("#phone").val(data.phone);
              $("#bankAccount").val(data.bankAccount);
              $("#email").val(data.email);
              $("#birthday").val(data.dateOfBirth);
              $("#startDate").val(data.startDate);
              $("#salary").val(data.salary);
              $("#status").val(data.status);

              // Thay đổi tiêu đề của modal thành "Sửa nhân viên"
              $("#addEmployeeModalLabel").text("Sửa nhân viên");

              // Ẩn trường mật khẩu khi sửa
              $("#addPassword").empty();

              // Hiển thị modal
              $("#addEmployeeModal").modal("show");
            },
            error: function (error) {
              console.log(error);
              alert("Đã xảy ra lỗi khi tải dữ liệu nhân viên.");
            },
          });
        }

        function handleDelete() {
          const id = $(this).data("id");
          console.log("Delete ID:", id); // Kiểm tra giá trị của ID

          if (!id) {
            alert("ID của nhân viên không hợp lệ. Vui lòng thử lại.");
            return;
          }

          if (confirm("Bạn có chắc chắn muốn xóa nhân viên này không?")) {
            $.ajax({
              url: `http://localhost:8081/api/employees/${id}`,
              type: "DELETE",
              success: function () {
                alert("Nhân viên đã được xóa thành công!");
                loadEmployees(); // Refresh lại danh sách nhân viên
              },
              error: function (error) {
                console.log(error);
                alert("Đã xảy ra lỗi khi xóa nhân viên.");
              },
            });
          }
        }

        // Xử lý sự kiện Thêm hoặc Cập nhật nhân viên
        $("#addEmployeeForm").submit(function (e) {
          e.preventDefault();

          const id = $("#employeeId").val();
          const method = id ? "PUT" : "POST"; // PUT nếu có id, POST nếu không có id
          const url = id
            ? `http://localhost:8081/api/employees/update`
            : "http://localhost:8081/api/employees/create";

          // Hiển thị trường mật khẩu nếu đang thêm mới
          if (!id && $("#password").length === 0) {
            $("#addPassword").html(`
                        <div class="mb-3">
                            <label for="password" class="form-label">Mật khẩu</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                    `);
          }

          const employeeData = {
            employeeId: id,
            fullName: $("#fullName").val(),
            position: $("#position").val(),
            taxCode: $("#taxCode").val(),
            address: $("#address").val(),
            phone: $("#phone").val(),
            bankAccount: $("#bankAccount").val(),
            email: $("#email").val(),
            dateOfBirth: $("#birthday").val(),
            startDate: $("#startDate").val(),
            salary: $("#salary").val(),
            status: $("#status").val(),
          };

          if (!id) {
            employeeData.password = $("#password").val();
          }

          $.ajax({
            url: url,
            type: method,
            contentType: "application/json",
            data: JSON.stringify(employeeData),
            success: function () {
              alert("Thông tin nhân viên đã được lưu thành công!");
              $("#addEmployeeModal").modal("hide");
              loadEmployees(); // Refresh lại danh sách nhân viên
            },
            error: function (error) {
              console.log(error);
              alert("Đã xảy ra lỗi khi lưu thông tin nhân viên.");
            },
          });
        });

        // Tải danh sách nhân viên khi trang được tải
        loadEmployees();

        // Reset form khi đóng modal
        $("#addEmployeeModal").on("hidden.bs.modal", function () {
          $("#addEmployeeForm")[0].reset();
          $("#employeeId").val("");
          $("#addPassword").empty(); // Xóa trường mật khẩu khi đóng modal
          $("#addEmployeeModalLabel").text("Thêm nhân viên mới");
        });

        // Hiển thị trường mật khẩu khi mở modal để thêm mới nhân viên
        $("#addEmployeeModal").on("show.bs.modal", function (e) {
          const id = $("#employeeId").val();

          // Nếu không có ID, tức là đang thêm mới nhân viên
          if (!id) {
            $("#addPassword").html(`
                        <div class="mb-3">
                            <label for="password" class="form-label">Mật khẩu</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                    `);
          }
        });
      });
    </script>
  </body>
</html>
